import json
import urllib.parse
import boto3

print('Loading function')


s3 = boto3.client('s3')

def lambda_handler(event, context):
	
	
    #1 - Get the bucket name
    bucket = event['Records'][0]['s3']['bucket']['name']

    #2 - Get the file/key name
    key = urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'], encoding='utf-8')
    

   
    #3 - Fetch the file from S3
    response = s3.get_object(Bucket=bucket, Key=key)
    target_bucket='blocketrequest'
    FILE='Filtered' + key
    
    

    #4 - Deserialize the file's content
    text = response["Body"].read().decode()
    e  = text.split("\n")
    
    
    #5 - Print the content
    # print(f"ResponseText:{text}")
    print(f"TotalRecords:{len(e)}")
    print(f"typeOfe:{type(e)}")
    print(f"FIRSTRECORD:{e[0]}")

    #6 - Parse and print the Action
    Output=[]
        
    for each in e:
        try:
            loaded_data = json.loads(each)
            if loaded_data["action"] == "BLOCKED":
                Output.append(loaded_data)
        except Exception as err:
            print(f"Problem with line:{str(err)}")
            break
        
        
    print(f"Total_filtered_records:{len(Output)}")
    print(f"OutputType:{type(Output)}")
    print(f"BlockedRequests:{Output}")
            
        
        
    s3.put_object(Body=json.dumps(Output),Bucket=target_bucket,Key=FILE)
    print('pushed ')
   
		
	
                    
                    

